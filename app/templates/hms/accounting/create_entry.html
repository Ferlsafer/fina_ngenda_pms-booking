{% extends "hms/layout/base.html" %}
{% block title %}Create Journal Entry - Accounting{% endblock %}

{% block content %}
<div class="container-xl">
  <!-- Page header -->
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">Create Journal Entry</h2>
        <div class="text-muted mt-1">Record a financial transaction</div>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <a href="{{ '#' }}" class="btn btn-secondary">Back to Dashboard</a>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <form method="POST" action="{{ '#' }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label required">Date</label>
              <input type="date" name="date" class="form-control" value="{{ today_date }}" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Reference</label>
              <input type="text" name="reference" class="form-control" placeholder="e.g. INV-001, PAY-001">
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="2" placeholder="Description of the transaction..."></textarea>
        </div>

        <h4 class="mb-3">Journal Lines</h4>
        <div id="journal-lines">
          <div class="journal-line row mb-2">
            <div class="col-5">
              <select name="account_id[]" class="form-select" required>
                <option value="">Select Account</option>
                {% for account in accounts %}
                <option value="{{ account.id }}">{{ account.name }} ({{ account.type }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-3">
              <input type="number" name="debit[]" class="form-control" step="0.01" placeholder="Debit" min="0">
            </div>
            <div class="col-3">
              <input type="number" name="credit[]" class="form-control" step="0.01" placeholder="Credit" min="0">
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-outline-danger remove-line" onclick="this.parentElement.parentElement.remove()">-</button>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-outline-primary" onclick="addJournalLine()">+ Add Line</button>

        <div class="row mt-3">
          <div class="col-md-6">
            <div class="text-end">
              <strong>Total Debits: $<span id="total-debits">0.00</span></strong>
            </div>
          </div>
          <div class="col-md-6">
            <div class="text-end">
              <strong>Total Credits: $<span id="total-credits">0.00</span></strong>
            </div>
          </div>
        </div>
        
        <div class="mt-3">
          <div id="balance-message" class="alert alert-warning d-none">Debits and credits must balance!</div>
        </div>

        <div class="form-footer">
          <button type="submit" class="btn btn-primary">Save Entry</button>
          <a href="{{ '#' }}" class="btn btn-link">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function addJournalLine() {
  const container = document.getElementById('journal-lines');
  const newLine = document.createElement('div');
  newLine.className = 'journal-line row mb-2';
  newLine.innerHTML = `
    <div class="col-5">
      <select name="account_id[]" class="form-select" required>
        <option value="">Select Account</option>
        {% for account in accounts %}
        <option value="{{ account.id }}">{{ account.name }} ({{ account.type }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-3">
      <input type="number" name="debit[]" class="form-control" step="0.01" placeholder="Debit" min="0">
    </div>
    <div class="col-3">
      <input type="number" name="credit[]" class="form-control" step="0.01" placeholder="Credit" min="0">
    </div>
    <div class="col-1">
      <button type="button" class="btn btn-outline-danger remove-line" onclick="this.parentElement.parentElement.remove()">-</button>
    </div>
  `;
  container.appendChild(newLine);

  // Add event listeners to the new inputs
  const debitInputs = document.querySelectorAll('input[name="debit[]"]');
  const creditInputs = document.querySelectorAll('input[name="credit[]"]');

  debitInputs.forEach(input => {
    input.addEventListener('input', updateTotals);
  });

  creditInputs.forEach(input => {
    input.addEventListener('input', updateTotals);
  });
}

function updateTotals() {
  let totalDebits = 0;
  let totalCredits = 0;

  document.querySelectorAll('input[name="debit[]"]').forEach(input => {
    if (input.value) {
      totalDebits += parseFloat(input.value) || 0;
    }
  });

  document.querySelectorAll('input[name="credit[]"]').forEach(input => {
    if (input.value) {
      totalCredits += parseFloat(input.value) || 0;
    }
  });

  document.getElementById('total-debits').textContent = totalDebits.toFixed(2);
  document.getElementById('total-credits').textContent = totalCredits.toFixed(2);
  
  // Check if debits and credits balance
  const balanceMessage = document.getElementById('balance-message');
  if (Math.abs(totalDebits - totalCredits) > 0.01) {
    balanceMessage.classList.remove('d-none');
  } else {
    balanceMessage.classList.add('d-none');
  }
}

// Add event listeners to existing inputs
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('input[name="debit[]"]').forEach(input => {
    input.addEventListener('input', updateTotals);
  });

  document.querySelectorAll('input[name="credit[]"]').forEach(input => {
    input.addEventListener('input', updateTotals);
  });
});
</script>
{% endblock %}