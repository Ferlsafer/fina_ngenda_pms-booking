{% if items %}
<div class="row g-3">
  {% for item in items %}
  <div class="col-sm-6 col-lg-4 col-xl-3" data-item-id="{{ item.id }}">
    <div class="card card-sm h-100">
      {% if item.image_url %}
      <img src="{{ item.image_url }}" class="card-img-top" alt="{{ item.name }}" style="height: 160px; object-fit: cover;">
      {% else %}
      <div class="card-img-top" style="height: 160px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
        <span class="text-white h1 mb-0">{{ item.name[0]|upper }}</span>
      </div>
      {% endif %}
      
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h4 class="card-title mb-0">{{ item.name }}</h4>
          <div class="dropdown">
            <button class="btn btn-icon btn-sm btn-ghost-secondary" type="button" data-bs-toggle="dropdown">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <circle cx="12" cy="12" r="1" />
                <circle cx="12" cy="19" r="1" />
                <circle cx="12" cy="5" r="1" />
              </svg>
            </button>
            <ul class="dropdown-menu">
              <li>
                <button class="dropdown-item" onclick="editItem({{ item.id }})">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M9 7h-3a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-3" />
                    <path d="M9 15h3l8.5 -8.5a1.5 1.5 0 0 0 -3 -3l-8.5 8.5v3" />
                  </svg>
                  Edit
                </button>
              </li>
              <li>
                <button class="dropdown-item" onclick="toggleAvailability({{ item.id }})">
                  {% if item.is_available %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2 text-warning" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <circle cx="12" cy="12" r="9" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                  </svg>
                  Mark Unavailable
                  {% else %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2 text-success" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <circle cx="12" cy="12" r="9" />
                    <path d="M9 12l2 2l4 -4" />
                  </svg>
                  Mark Available
                  {% endif %}
                </button>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <button class="dropdown-item text-danger" onclick="deleteItem({{ item.id }})">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <line x1="4" y1="7" x2="20" y2="7" />
                    <line x1="10" y1="11" x2="10" y2="17" />
                    <line x1="14" y1="11" x2="14" y2="17" />
                    <path d="M5 7l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -14" />
                    <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                  </svg>
                  Delete
                </button>
              </li>
            </ul>
          </div>
        </div>
        
        <div class="text-muted small mb-2">{{ item.category.name if item.category else 'Uncategorized' }}</div>
        
        {% if item.description %}
        <p class="small text-muted mb-2">{{ item.description|truncate(60) }}</p>
        {% endif %}
        
        <!-- Inventory Status -->
        {% if item.inventory_items %}
        <div class="mb-2">
          {% for link in item.inventory_items %}
          <span class="badge bg-{% if link.inventory_item.current_stock >= link.quantity_needed %}success{% else %}danger{% endif %} me-1" title="{{ link.inventory_item.name }}: {{ link.inventory_item.current_stock }} available">
            {{ link.inventory_item.name|truncate(15) }}
          </span>
          {% endfor %}
        </div>
        {% endif %}
        
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div>
            <span class="h4 mb-0">${{ "%.2f"|format(item.price) }}</span>
            {% if item.cost %}
            <small class="text-muted d-block">Margin: {{ "%.0f"|format((item.price - item.cost) / item.price * 100) }}%</small>
            {% endif %}
          </div>
          <span class="badge bg-{% if item.is_available %}success{% else %}secondary{% endif %}">
            {{ 'Available' if item.is_available else 'Unavailable' }}
          </span>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
  <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-3" width="48" height="48" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
    <path d="M3 3h18v18h-18z" />
    <line x1="9" y1="9" x2="15" y2="15" />
    <line x1="15" y1="9" x2="9" y2="15" />
  </svg>
  <h3>No items in this category</h3>
  <p class="text-muted">Click "Add Menu Item" to create your first item</p>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#item-modal">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19" />
      <line x1="5" y1="12" x2="19" y2="12" />
    </svg>
    Add Menu Item
  </button>
</div>
{% endif %}

<script>
function editItem(itemId) {
  // Use the existing function from item_form.html
  if (typeof loadItemData === 'function') {
    loadItemData(itemId);
  } else {
    // Fallback: redirect to edit page
    window.location.href = `/restaurant/item/${itemId}/edit`;
  }
}

function toggleAvailability(itemId) {
  fetch(`/restaurant/item/${itemId}/toggle`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token() }}',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the UI
      const badge = document.querySelector(`[data-item-id="${itemId}"] .badge`);
      if (badge) {
        const isAvailable = badge.textContent.trim() === 'Available';
        badge.textContent = isAvailable ? 'Unavailable' : 'Available';
        badge.classList.toggle('bg-success', !isAvailable);
        badge.classList.toggle('bg-secondary', isAvailable);
      }
    }
  });
}

function deleteItem(itemId) {
  if (confirm('Are you sure you want to delete this menu item? This action cannot be undone.')) {
    fetch(`/restaurant/item/${itemId}/delete`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token() }}',
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Remove item from UI
        const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
        if (itemElement) {
          itemElement.remove();
        }
        // Update category counts
        updateCategoryCounts();
      }
    });
  }
}

function updateCategoryCounts() {
  fetch('/restaurant/api/categories')
    .then(response => response.json())
    .then(data => {
      // Update the category tabs with new counts
      data.categories.forEach(category => {
        const tab = document.querySelector(`#cat-${category.id}-tab .badge`);
        if (tab) {
          tab.textContent = category.item_count;
        }
      });
      
      // Update the "All" tab count
      const totalItems = data.categories.reduce((sum, cat) => sum + cat.item_count, 0);
      const allTab = document.querySelector('#all-tab .badge');
      if (allTab) {
        allTab.textContent = totalItems;
      }
    });
}
</script>
