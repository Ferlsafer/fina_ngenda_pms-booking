{% extends "hms/layout/base.html" %}
{% block title %}POS - Restaurant - Hotel PMS{% endblock %}

{% block head %}
<style>
  .pos-floor { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.75rem; }
  .table-btn { min-height: 80px; font-weight: 600; border-radius: 8px; transition: all 0.2s; }
  .table-btn.available { background: var(--tblr-success-bg); border-color: var(--tblr-success); color: var(--tblr-success); }
  .table-btn.occupied { background: var(--tblr-primary-bg); border-color: var(--tblr-primary); color: var(--tblr-primary); }
  .table-btn.reserved { background: var(--tblr-warning-bg); border-color: var(--tblr-warning); color: var(--tblr-warning); }
  .table-btn.active { box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5); transform: scale(1.05); }
  .item-tile { min-height: 60px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
  .item-tile:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .order-sidebar { max-height: calc(100vh - 200px); overflow-y: auto; }
  @media (max-width: 768px) { .pos-floor { grid-template-columns: repeat(4, 1fr); } }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">
        Restaurant POS
        <span id="active-orders-badge" class="badge bg-secondary ms-2">0</span>
      </h2>
      <div class="text-muted mt-1">Point of sale — tap a table to open an order</div>
    </div>
    <div class="col-auto">
      <a href="{{ url_for('hms.restaurant_menu') }}" class="btn btn-outline-secondary">Menu</a>
      <a href="{{ url_for('hms.restaurant_tables') if url_for is defined else '#' }}" class="btn btn-outline-primary">Table Map</a>
    </div>
  </div>
</div>

<div class="row">
  <!-- Tables grid (floor plan) -->
  <div class="col-lg-5 col-xl-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Floor plan</h3>
        <div class="card-actions">
          <span class="badge bg-success me-1">Available</span>
          <span class="badge bg-primary me-1">Occupied</span>
          <span class="badge bg-warning">Reserved</span>
        </div>
      </div>
      <div class="card-body">
        <div class="pos-floor" id="pos-floor">
          {% if tables %}
          {% for t in tables %}
          <button type="button" class="btn table-btn {{ t.status|default('available') }}" data-table-id="{{ t.id }}" data-table-number="{{ t.table_number }}">
            Table {{ t.table_number }}
          </button>
          {% endfor %}
          {% else %}
          <!-- No tables - show message -->
          <div class="col-12">
            <div class="alert alert-warning" role="alert">
              <i class="fa fa-exclamation-triangle"></i>
              <strong>No tables found!</strong>
              <p class="mb-0 mt-2">Go to <a href="{{ url_for('hms.restaurant_tables') }}">Table Management</a> to add tables first.</p>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Quick item grid (shown when table selected) -->
  <div class="col-lg-7 col-xl-8">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Quick items</h3>
        <span class="text-muted ms-2" id="current-table-label">Select a table</span>
      </div>
      <div class="card-body">
        <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-2" id="quick-items">
          <!-- Load menu items from database -->
          {% if menu_items %}
            {% for item in menu_items %}
          <div class="col">
            <button type="button" class="btn btn-outline-primary w-100 item-tile d-flex flex-column align-items-center justify-content-center py-2 add-item-btn" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}" data-item-price="{{ item.price }}">
              <span class="small text-truncate w-100">{{ item.name }}</span>
              <span class="text-muted small">${{ "%.2f"|format(item.price) }}</span>
            </button>
          </div>
            {% endfor %}
          {% else %}
          <div class="col-12">
            <div class="alert alert-warning" role="alert">
              <i class="fa fa-exclamation-triangle"></i>
              <strong>No menu items found!</strong>
              <p class="mb-0 mt-2">Go to <a href="{{ url_for('hms.restaurant_menu') }}">Menu Management</a> to add items first.</p>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Order summary sidebar (sticky on desktop) -->
    <div class="card mt-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">Order summary</h3>
        <span class="badge bg-secondary" id="order-table-badge">—</span>
      </div>
      <div class="card-body order-sidebar">
        <div id="order-lines-container">
          <p class="text-muted mb-0" id="order-empty-msg">No items. Select a table and add items.</p>
          <ul class="list-group list-group-flush d-none" id="order-lines-list"></ul>
        </div>
        <hr>
        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal</span>
          <span id="order-subtotal">$0.00</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Tax (18%)</span>
          <span id="order-tax">$0.00</span>
        </div>
        <div class="d-flex justify-content-between fw-bold fs-4">
          <span>Total</span>
          <span id="order-total">$0.00</span>
        </div>
        <div class="mt-3 d-flex flex-wrap gap-2">
          <button type="button" class="btn btn-primary flex-grow-1" id="btn-send-kitchen" disabled>Send to Kitchen</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#splitBillModal">Split Bill</button>
          <button type="button" class="btn btn-outline-info" id="btn-print-receipt" disabled>Print Receipt</button>
        </div>
        <div class="mt-2 d-flex flex-wrap gap-2">
          <button type="button" class="btn btn-success" id="btn-pay-cash" disabled>Cash</button>
          <button type="button" class="btn btn-info text-white" id="btn-pay-card" disabled>Card</button>
          <button type="button" class="btn btn-warning" id="btn-pay-room" disabled>Room Charge</button>
          <button type="button" class="btn btn-outline-danger" id="btn-clear-order">Clear</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Order Modal (table order detail) -->
<div class="modal modal-blur fade" id="orderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Order — Table <span id="modal-table-number">—</span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="current-table-id" value="">
        <p class="text-muted">Add items from the quick items grid, then send to kitchen or process payment.</p>
        <div id="modal-order-lines"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="modal-send-kitchen">Send to Kitchen</button>
      </div>
    </div>
  </div>
</div>

<!-- Split Bill Modal -->
<div class="modal modal-blur fade" id="splitBillModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="#" id="split-bill-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title">Split bill</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Number of ways</label>
            <select name="split_ways" class="form-select" id="split-ways">
              <option value="2">2 ways</option>
              <option value="3">3 ways</option>
              <option value="4">4 ways</option>
              <option value="5">5 ways</option>
              <option value="6">6 ways</option>
            </select>
          </div>
          <div class="alert alert-info">
            <strong>Current Order Total:</strong> $<span id="split-bill-total">0.00</span><br>
            <strong>Per Person:</strong> $<span id="split-bill-per-person">0.00</span>
          </div>
          <p class="text-muted small">Total will be divided equally among all parties.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="btn-split-confirm">Split Bill</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm clear order -->
<div class="modal modal-blur fade" id="confirmClearModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <p class="mb-0">Clear current order? This cannot be undone.</p>
      </div>
      <div class="modal-footer flex-nowrap">
        <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-clear-btn">Clear order</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // Tax rate from backend config (standardized)
  const TAX_RATE = 0.18; // 18% default
  const TAX_RATE_DISPLAY = 18;
  let currentTableId = null;
  let currentTableNumber = null;
  let orderLines = [];

  console.log('POS Script loaded');
  console.log('Tables found:', document.querySelectorAll('.table-btn').length);
  console.log('Menu items found:', document.querySelectorAll('.add-item-btn').length);

  const $tableBadge = document.getElementById('order-table-badge');
  const $currentTableLabel = document.getElementById('current-table-label');
  const $orderEmptyMsg = document.getElementById('order-empty-msg');
  const $orderLinesList = document.getElementById('order-lines-list');
  const $subtotal = document.getElementById('order-subtotal');
  const $tax = document.getElementById('order-tax');
  const $total = document.getElementById('order-total');

  function formatMoney(n) { return '$' + Number(n).toFixed(2); }

  function renderOrderLines() {
    if (orderLines.length === 0) {
      $orderEmptyMsg.classList.remove('d-none');
      $orderLinesList.classList.add('d-none');
    } else {
      $orderEmptyMsg.classList.add('d-none');
      $orderLinesList.classList.remove('d-none');
      $orderLinesList.innerHTML = orderLines.map((line, i) =>
        '<li class="list-group-item d-flex justify-content-between align-items-center">' +
        '<span>' + line.name + ' × ' + line.qty + '</span>' +
        '<div><span class="me-2">' + formatMoney(line.price * line.qty) + '</span>' +
        '<button type="button" class="btn btn-sm btn-ghost-danger remove-line" data-index="' + i + '">Remove</button></div></li>'
      ).join('');
      $orderLinesList.querySelectorAll('.remove-line').forEach(btn => {
        btn.addEventListener('click', function() { removeLine(parseInt(this.dataset.index)); });
      });
    }
    const subtotal = orderLines.reduce((s, l) => s + l.price * l.qty, 0);
    const tax = subtotal * TAX_RATE;
    $subtotal.textContent = formatMoney(subtotal);
    $tax.textContent = formatMoney(tax);
    $total.textContent = formatMoney(subtotal + tax);
  }

  // Show message to user (success or error)
  function showMessage(text, type = 'info') {
    const colors = {
      success: 'bg-success',
      error: 'bg-danger',
      warning: 'bg-warning',
      info: 'bg-info'
    };
    const msgDiv = document.createElement('div');
    msgDiv.className = 'alert ' + (colors[type] || colors.info) + ' text-white alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    msgDiv.style.zIndex = '9999';
    msgDiv.innerHTML = 
      text +
      '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>';
    document.body.appendChild(msgDiv);
    setTimeout(() => msgDiv.remove(), 5000);
  }

  function setTable(tableId, tableNumber) {
    currentTableId = tableId;
    currentTableNumber = tableNumber;
    $tableBadge.textContent = 'Table ' + tableNumber;
    $currentTableLabel.textContent = 'Table ' + tableNumber;
    document.getElementById('modal-table-number').textContent = tableNumber;
    document.getElementById('current-table-id').value = tableId;
  }

  function addItem(id, name, price) {
    const existing = orderLines.find(l => l.id === id && !l.modifiers);
    if (existing) { existing.qty++; } else { orderLines.push({ id, name, price, qty: 1 }); }
    renderOrderLines();
    document.getElementById('btn-send-kitchen').disabled = orderLines.length === 0;
    document.getElementById('btn-pay-cash').disabled = orderLines.length === 0;
    document.getElementById('btn-pay-card').disabled = orderLines.length === 0;
    document.getElementById('btn-pay-room').disabled = orderLines.length === 0;
    document.getElementById('btn-print-receipt').disabled = orderLines.length === 0;
  }

  function removeLine(index) {
    orderLines.splice(index, 1);
    renderOrderLines();
  }

  function clearOrder() {
    orderLines = [];
    renderOrderLines();
    document.getElementById('btn-send-kitchen').disabled = true;
    document.getElementById('btn-pay-cash').disabled = true;
    document.getElementById('btn-pay-card').disabled = true;
    document.getElementById('btn-pay-room').disabled = true;
    document.getElementById('btn-print-receipt').disabled = true;
  }

  // Table selection - set current table when clicked
  document.getElementById('pos-floor').addEventListener('click', function(e) {
    const tableBtn = e.target.closest('.table-btn');
    if (tableBtn) {
      setTable(tableBtn.dataset.tableId, tableBtn.dataset.tableNumber);
      // Highlight selected table
      document.querySelectorAll('.table-btn').forEach(btn => btn.classList.remove('active'));
      tableBtn.classList.add('active');
    }
  });

  document.querySelectorAll('.add-item-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      if (!currentTableId) {
        showMessage('Please select a table first!', 'warning');
        return;
      }
      addItem(this.dataset.itemId, this.dataset.itemName, parseFloat(this.dataset.itemPrice));
    });
  });

  document.getElementById('btn-send-kitchen').addEventListener('click', async function() {
    if (orderLines.length === 0) return;
    
    const tableId = currentTableId;
    const items = orderLines.map(line => ({
      item_id: line.id,
      quantity: line.qty
    }));
    
    try {
      const formData = new FormData();
      formData.append('table_id', tableId);
      formData.append('order_type', 'dine_in');
      items.forEach(item => {
        formData.append('item_id[]', item.item_id);
        formData.append('quantity[]', item.quantity);
      });
      
      const response = await fetch('/hms/restaurant/pos/order/create', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (result.success) {
        showMessage(`Order #${result.order_id} created! Total: $${result.total.toFixed(2)}`, 'success');
        clearOrder();
        // Reload page to show updated table status
        setTimeout(() => location.reload(), 1500);
      } else {
        showMessage(result.message || result.error || 'Failed to create order', 'error');
      }
    } catch (error) {
      showMessage('Network error. Please try again.', 'error');
      console.error('Order creation error:', error);
    }
  });

  document.getElementById('btn-clear-order').addEventListener('click', function() {
    if (orderLines.length === 0) return;
    var m = new bootstrap.Modal(document.getElementById('confirmClearModal'));
    m.show();
  });
  document.getElementById('confirm-clear-btn').addEventListener('click', function() {
    clearOrder();
    bootstrap.Modal.getInstance(document.getElementById('confirmClearModal')).hide();
  });

  // Payment buttons - create order with payment
  async function processPayment(method, bookingId = null) {
    if (orderLines.length === 0) {
      showMessage('Please add items to order first', 'warning');
      return;
    }

    const tableId = currentTableId;
    const total = orderLines.reduce((s, l) => s + l.price * l.qty, 0);
    const tax = total * TAX_RATE;
    const orderTotal = total + tax;

    // For room charge, skip payment amount prompt
    let paid = 0;
    if (method !== 'room_charge') {
      // Ask for payment amount
      const paidAmount = prompt(`Total: $${orderTotal.toFixed(2)}\nEnter payment amount:`, orderTotal.toFixed(2));
      if (!paidAmount) return;

      paid = parseFloat(paidAmount);
      if (isNaN(paid) || paid <= 0) {
        showMessage('Invalid payment amount', 'error');
        return;
      }
    }

    const formData = new FormData();
    formData.append('table_id', tableId);
    formData.append('order_type', 'dine_in');
    formData.append('payment_method', method);
    formData.append('paid_amount', paid);
    
    // Add booking_id for room charge (Phase 1.3 Fix)
    if (bookingId) {
      formData.append('booking_id', bookingId);
    }
    
    orderLines.forEach(line => {
      formData.append('item_id[]', line.id);
      formData.append('quantity[]', line.qty);
    });

    try {
      const response = await fetch('/hms/restaurant/pos/order/create', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        let msg = result.message || `Order #${result.order_id} created!`;
        if (result.balance_due > 0) {
          msg += ` Balance due: $${result.balance_due.toFixed(2)}`;
        }
        showMessage(msg, 'success');
        // Print receipt after successful payment
        printReceipt({order_id: result.order_id});
        clearOrder();
        setTimeout(() => location.reload(), 1500);
      } else {
        showMessage(result.message || result.error || 'Payment failed', 'error');
      }
    } catch (error) {
      showMessage('Network error. Please try again.', 'error');
      console.error('Payment error:', error);
    }
  }

  // Print receipt button
  document.getElementById('btn-print-receipt').addEventListener('click', function() {
    if (orderLines.length === 0) {
      showMessage('No order to print', 'warning');
      return;
    }
    printReceipt({order_id: 'Preview'});
  });

  document.getElementById('btn-pay-cash').addEventListener('click', function() {
    processPayment('cash');
  });

  document.getElementById('btn-pay-card').addEventListener('click', function() {
    processPayment('card');
  });

  document.getElementById('btn-pay-room').addEventListener('click', function() {
    // For room charge, ask for booking/room number
    const bookingNumber = prompt('Enter booking number (not room number):');
    if (bookingNumber) {
      // Pass booking number to processPayment
      processPayment('room_charge', parseInt(bookingNumber));
    }
  });

  // Real-time order status polling (every 10 seconds)
  let lastOrdersHash = '';
  async function pollActiveOrders() {
    try {
      const response = await fetch('/hms/restaurant/pos/orders/active');
      const result = await response.json();
      
      if (result.success) {
        // Create a hash of current orders to detect changes
        const currentHash = JSON.stringify(result.orders);
        if (currentHash !== lastOrdersHash && lastOrdersHash !== '') {
          // Orders changed - show notification
          const activeCount = result.orders.length;
          const preparingCount = result.orders.filter(o => o.status === 'preparing').length;
          const readyCount = result.orders.filter(o => o.status === 'ready').length;
          
          const badge = document.getElementById('active-orders-badge');
          if (badge) {
            badge.textContent = activeCount;
            badge.className = `badge ${activeCount > 0 ? 'bg-primary' : 'bg-secondary'} ms-2`;
          }
          
          // Show subtle notification if there are ready orders
          if (readyCount > 0) {
            showMessage(`${readyCount} order(s) ready for serving!`, 'info');
          }
        }
        lastOrdersHash = currentHash;
      }
    } catch (error) {
      console.error('Polling error:', error);
    }
  }

  // Split bill functionality
  let currentSplitOrderId = null;
  document.getElementById('btn-split-confirm').addEventListener('click', async function() {
    if (!currentSplitOrderId) {
      showMessage('No active order to split', 'warning');
      return;
    }

    const splitWays = parseInt(document.getElementById('split-ways').value);

    try {
      const response = await fetch(`/hms/restaurant/pos/order/${currentSplitOrderId}/split`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({split_ways: splitWays, split_type: 'equal'})
      });

      const result = await response.json();
      if (result.success) {
        showMessage(`Bill split into ${splitWays} orders! New order IDs: ${result.split_order_ids.join(', ')}`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('splitBillModal')).hide();
        // Reload to show updated orders
        setTimeout(() => location.reload(), 2000);
      } else {
        showMessage(result.error || 'Split failed', 'error');
      }
    } catch (error) {
      showMessage('Network error', 'error');
      console.error('Split error:', error);
    }
  });

  // Update split bill preview when modal opens
  document.getElementById('splitBillModal').addEventListener('show.bs.modal', async function() {
    const total = orderLines.reduce((s, l) => s + l.price * l.qty, 0);
    const tax = total * TAX_RATE;
    const orderTotal = total + tax;

    document.getElementById('split-bill-total').textContent = orderTotal.toFixed(2);

    // Get the active order ID for this table from backend
    try {
      const response = await fetch(`/hms/restaurant/pos/orders/active`);
      const result = await response.json();
      if (result.success && result.orders.length > 0) {
        // Find order for current table
        const tableOrder = result.orders.find(o => o.table_id === parseInt(currentTableId));
        if (tableOrder) {
          currentSplitOrderId = tableOrder.id;
        } else {
          showMessage('No active order found for this table', 'warning');
          currentSplitOrderId = null;
        }
      }
    } catch (error) {
      console.error('Error getting order ID:', error);
    }

    // Update per person preview when split ways changes
    const updatePerPerson = () => {
      const ways = parseInt(document.getElementById('split-ways').value);
      const perPerson = orderTotal / ways;
      document.getElementById('split-bill-per-person').textContent = perPerson.toFixed(2);
    };

    document.getElementById('split-ways').addEventListener('change', updatePerPerson);
    updatePerPerson(); // Initial calculation
  });

  // Receipt printing
  function printReceipt(order) {
    const printWindow = window.open('', '_blank');
    const itemsHtml = orderLines.map(function(line) {
      return '<tr><td>' + line.name + ' x' + line.qty + '</td><td style="text-align:right">$' + (line.price * line.qty).toFixed(2) + '</td></tr>';
    }).join('');

    const subtotal = orderLines.reduce(function(s, l) { return s + l.price * l.qty; }, 0);
    const tax = subtotal * TAX_RATE;
    const total = subtotal + tax;

    printWindow.document.write(
      "<!DOCTYPE html>" +
      "<html><head><title>Receipt - Order #" + (order.order_id || "New") + "</title>" +
      "<style>body{font-family:\"Courier New\",monospace;padding:20px;max-width:400px;margin:0 auto}h2{text-align:center;margin-bottom:5px}.header{text-align:center;margin-bottom:20px}table{width:100%;border-collapse:collapse}td{padding:5px 0}.total-row{font-weight:bold;border-top:1px dashed #000;padding-top:10px}.footer{text-align:center;margin-top:20px;font-size:12px}@media print{body{padding:0}}</style>" +
      "</head><body>" +
      "<div class=\"header\"><h2>Ngenda Hotel</h2><p>Restaurant Receipt</p><p>Table " + (currentTableNumber || "N/A") + "</p><p>" + new Date().toLocaleString() + "</p></div>" +
      "<table>" + itemsHtml +
      "<tr class=\"total-row\"><td>Subtotal</td><td style=\"text-align:right\">$" + subtotal.toFixed(2) + "</td></tr>" +
      "<tr><td>Tax (" + (TAX_RATE * 100) + "%)</td><td style=\"text-align:right\">$" + tax.toFixed(2) + "</td></tr>" +
      "<tr class=\"total-row\"><td>TOTAL</td><td style=\"text-align:right\">$" + total.toFixed(2) + "</td></tr>" +
      "</table>" +
      "<div class=\"footer\"><p>Thank you for dining with us!</p><p>Ngenda Hotel - Mbeya, Tanzania</p></div>" +
      "<scr" + "ipt>window.onload=function(){window.print();}</scr" + "ipt>" +
      "</body></html>"
    );
    printWindow.document.close();
  }

  // Add print receipt button handler (can be triggered after payment)
  window.printReceipt = printReceipt;

  // Start polling when page loads
  setInterval(pollActiveOrders, 10000);
  // Initial poll after 2 seconds
  setTimeout(pollActiveOrders, 2000);

  console.log('POS initialization complete');
})();
</script>
{% endblock %}
