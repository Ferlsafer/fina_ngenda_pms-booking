{% extends "hms/layout/base.html" %}
{% block title %}Housekeeping{% endblock %}

{% block content %}
<div class="container-xl">
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">Housekeeping</h2>
        <div class="text-muted mt-1">Manage room cleaning tasks and maintenance</div>
      </div>
    </div>
  </div>

  <!-- Status Overview -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto"><span class="bg-green text-white avatar"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg></span></div>
            <div class="col"><div class="font-weight-medium">{{ status_counts.Vacant }} Vacant</div><div class="text-muted small">Ready for guests</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto"><span class="bg-blue text-white avatar"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /><path d="M12 3a9 9 0 0 1 9 9a9 9 0 0 1 -9 9a9 9 0 0 1 -9 -9a9 9 0 0 1 9 -9z" /></svg></span></div>
            <div class="col"><div class="font-weight-medium">{{ status_counts.Occupied }} Occupied</div><div class="text-muted small">Guests in room</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto"><span class="bg-yellow text-white avatar"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 9v2m0 4v.01" /><path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75" /></svg></span></div>
            <div class="col"><div class="font-weight-medium">{{ status_counts.Dirty }} Dirty</div><div class="text-muted small">Needs cleaning</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto"><span class="bg-purple text-white avatar"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4h16v16h-16z" /></svg></span></div>
            <div class="col"><div class="font-weight-medium">{{ status_counts.Reserved }} Reserved</div><div class="text-muted small">Booked rooms</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks Section -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header"><h3 class="card-title">Pending Tasks ({{ pending_tasks|length }})</h3></div>
        <div class="card-body">
          {% if pending_tasks %}
          {% for task in pending_tasks %}
          <div class="card mb-2">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Room {{ task.room.room_number if task.room else 'N/A' }}</strong>
                  <span class="badge bg-{{ 'warning' if task.priority == 'high' else 'info' }}">{{ task.task_type }}</span>
                </div>
                <div>
                  <form method="post" action="{{ url_for('hms.housekeeping_start_task', task_id=task.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button class="btn btn-sm btn-primary">Start</button>
                  </form>
                </div>
              </div>
              <small class="text-muted">{{ task.created_at.strftime('%H:%M') }} - {{ task.notes or 'No notes' }}</small>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <p class="text-muted">No pending tasks</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header"><h3 class="card-title">In Progress ({{ in_progress_tasks|length }})</h3></div>
        <div class="card-body">
          {% if in_progress_tasks %}
          {% for task in in_progress_tasks %}
          <div class="card mb-2">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Room {{ task.room.room_number if task.room else 'N/A' }}</strong>
                  <span class="badge bg-primary">{{ task.task_type }}</span>
                </div>
                <form method="post" action="{{ url_for('hms.housekeeping_complete_task', task_id=task.id) }}" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <button class="btn btn-sm btn-success">Complete</button>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <p class="text-muted">No tasks in progress</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Rooms Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Rooms by Floor & Status</h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-vcenter card-table table-hover">
          <thead>
            <tr>
              <th>Floor</th>
              <th>Room Number</th>
              <th>Room Type</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for room in rooms %}
            <tr>
              <td>{% if room.floor %}<span class="badge bg-azure-lt">Floor {{ room.floor }}</span>{% else %}<span class="text-muted">N/A</span>{% endif %}</td>
              <td><strong>{{ room.room_number }}</strong></td>
              <td>{{ room.room_type.name }}</td>
              <td><span class="badge bg-{{ 'green' if room.status == 'Vacant' else 'blue' if room.status == 'Occupied' else 'yellow' if room.status == 'Dirty' else 'purple' }}-lt">{{ room.status }}</span></td>
              <td>
                {% if room.status == 'Dirty' %}
                <form method="post" action="{{ url_for('hms.housekeeping_clean_room', room_id=room.id) }}" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <button type="submit" class="btn btn-sm btn-success">Mark Clean</button>
                </form>
                <form method="post" action="{{ url_for('hms.housekeeping_create_task', room_id=room.id) }}" class="d-inline ms-2">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <input type="hidden" name="task_type" value="regular_clean"/>
                  <button type="submit" class="btn btn-sm btn-primary">Create Task</button>
                </form>
                {% elif room.status == 'Occupied' %}
                <form method="post" action="{{ url_for('hms.housekeeping_create_task', room_id=room.id) }}" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <input type="hidden" name="task_type" value="service"/>
                  <button type="submit" class="btn btn-sm btn-info">Service Request</button>
                </form>
                <button type="button" class="btn btn-sm btn-warning" disabled>Guest In Room</button>
                {% elif room.status == 'Vacant' %}
                <form method="post" action="{{ url_for('hms.housekeeping_dirty_room', room_id=room.id) }}" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <button type="submit" class="btn btn-sm btn-warning">Mark Dirty</button>
                </form>
                <button type="button" class="btn btn-sm btn-success" disabled>Ready</button>
                {% else %}
                <form method="post" action="{{ url_for('hms.housekeeping_create_task', room_id=room.id) }}" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <input type="hidden" name="task_type" value="inspection"/>
                  <button type="submit" class="btn btn-sm btn-primary">Create Task</button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
