{% extends "hms/layout/base.html" %}
{% block title %}Edit Purchase Order{% endblock %}

{% block content %}
<div class="container-xl">
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">Edit Purchase Order</h2>
        <div class="text-muted mt-1">PO-{{ po.po_number }} - {{ po.supplier.name }}</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <form method="POST" action="#">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Supplier</label>
              <select name="supplier_id" class="form-select" required>
                <option value="">Select Supplier</option>
                {% for supplier in suppliers %}
                <option value="{{ supplier.id }}" {% if supplier.id == po.supplier_id %}selected{% endif %}>
                  {{ supplier.name }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Order Date</label>
              <input type="date" name="order_date" class="form-control" value="{{ po.order_date.strftime('%Y-%m-%d') if po.order_date else '' }}" required>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Expected Delivery Date</label>
              <input type="date" name="expected_date" class="form-control" value="{{ po.expected_date.strftime('%Y-%m-%d') if po.expected_date else '' }}">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                <option value="draft" {% if po.status == 'draft' %}selected{% endif %}>Draft</option>
                <option value="ordered" {% if po.status == 'ordered' %}selected{% endif %}>Ordered</option>
                <option value="received" {% if po.status == 'received' %}selected{% endif %}>Received</option>
                <option value="cancelled" {% if po.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
              </select>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-control">{{ po.notes or '' }}</textarea>
        </div>

        <h4 class="mt-4">Items</h4>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Quantity</th>
                <th>Unit Cost</th>
                <th>Total</th>
                <th class="w-1"></th>
              </tr>
            </thead>
            <tbody id="items-container">
              {% for item in po.items %}
              <tr>
                <td>
                  <select name="item_id[]" class="form-select" required>
                    <option value="">Select Item</option>
                    {% for inv_item in items %}
                    <option value="{{ inv_item.id }}" {% if inv_item.id == item.item_id %}selected{% endif %}>
                      {{ inv_item.name }} ({{ inv_item.sku }})
                    </option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="number" name="quantity[]" class="form-control" value="{{ item.quantity }}" min="0.01" step="0.01" required>
                </td>
                <td>
                  <input type="number" name="unit_cost[]" class="form-control" value="{{ item.unit_cost }}" min="0" step="0.01" required>
                </td>
                <td class="align-middle">
                  $<span class="item-total">{{ "%.2f"|format(item.quantity * item.unit_cost) }}</span>
                </td>
                <td>
                  <button type="button" class="btn btn-sm btn-outline-danger remove-item">Remove</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <button type="button" class="btn btn-outline-primary" id="add-item">+ Add Item</button>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">Update Purchase Order</button>
          <a href="#" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add item functionality
  document.getElementById('add-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const newRow = document.createElement('tr');
    
    newRow.innerHTML = `
      <td>
        <select name="item_id[]" class="form-select" required>
          <option value="">Select Item</option>
          {% for item in items %}
          <option value="{{ item.id }}">{{ item.name }} ({{ item.sku }})</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <input type="number" name="quantity[]" class="form-control" value="1" min="0.01" step="0.01" required>
      </td>
      <td>
        <input type="number" name="unit_cost[]" class="form-control" value="0" min="0" step="0.01" required>
      </td>
      <td class="align-middle">
        $<span class="item-total">0.00</span>
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-danger remove-item">Remove</button>
      </td>
    `;
    
    container.appendChild(newRow);
    
    // Add event listener to the new remove button
    newRow.querySelector('.remove-item').addEventListener('click', function() {
      this.closest('tr').remove();
    });
  });

  // Remove item functionality
  document.querySelectorAll('.remove-item').forEach(button => {
    button.addEventListener('click', function() {
      this.closest('tr').remove();
    });
  });

  // Calculate totals when quantity or unit cost changes
  document.querySelectorAll('input[name="quantity[]"], input[name="unit_cost[]"]').forEach(input => {
    input.addEventListener('input', function() {
      const row = this.closest('tr');
      const quantity = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
      const unitCost = parseFloat(row.querySelector('input[name="unit_cost[]"]').value) || 0;
      const total = quantity * unitCost;
      row.querySelector('.item-total').textContent = total.toFixed(2);
    });
  });
});
</script>
{% endblock %}