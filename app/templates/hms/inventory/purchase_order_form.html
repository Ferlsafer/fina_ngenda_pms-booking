{% extends "hms/layout/base.html" %}
{% block title %}New Purchase Order{% endblock %}

{% block content %}
<div class="container-xl">
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">New Purchase Order</h2>
        <div class="text-muted mt-1">Create a new purchase order for inventory items</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <form method="POST" action="{{ url_for('hms.purchase_order_add') }}">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label required">Supplier</label>
              <select name="supplier_id" class="form-select" required>
                <option value="">Select Supplier</option>
                {% for supplier in suppliers %}
                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label required">Order Date</label>
              <input type="date" name="order_date" class="form-control" value="{{ today_date }}" required>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Expected Delivery Date</label>
              <input type="date" name="expected_date" class="form-control">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Reference Number</label>
              <input type="text" name="reference" class="form-control" placeholder="PO-REF-001">
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-control" rows="3" placeholder="Additional notes for this purchase order"></textarea>
        </div>

        <h4 class="mt-4">Items</h4>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Quantity</th>
                <th>Unit Cost</th>
                <th>Total</th>
                <th class="w-1"></th>
              </tr>
            </thead>
            <tbody id="items-container">
              <tr>
                <td>
                  <select name="item_id[]" class="form-select" required>
                    <option value="">Select Item</option>
                    {% for item in items %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="number" name="quantity[]" class="form-control" value="1" min="0.01" step="0.01" required>
                </td>
                <td>
                  <input type="number" name="unit_cost[]" class="form-control" value="0" min="0" step="0.01" required>
                </td>
                <td class="align-middle">
                  $<span class="item-total">0.00</span>
                </td>
                <td>
                  <button type="button" class="btn btn-sm btn-outline-danger remove-item">Remove</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button type="button" class="btn btn-outline-primary" id="add-item">+ Add Item</button>

        <div class="mt-4">
          <div class="row">
            <div class="col-md-8"></div>
            <div class="col-md-4">
              <table class="table">
                <tr>
                  <td><strong>Subtotal:</strong></td>
                  <td class="text-end">$<span id="subtotal">0.00</span></td>
                </tr>
                <tr>
                  <td><strong>Tax (0%):</strong></td>
                  <td class="text-end">$<span id="tax">0.00</span></td>
                </tr>
                <tr>
                  <td><strong>Total:</strong></td>
                  <td class="text-end">$<span id="total">0.00</span></td>
                </tr>
              </table>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">Create Purchase Order</button>
          <a href="{{ url_for('hms.inventory_purchase_orders') }}" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add item functionality
  document.getElementById('add-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const newRow = document.createElement('tr');
    
    newRow.innerHTML = `
      <td>
        <select name="item_id[]" class="form-select" required>
          <option value="">Select Item</option>
          {% for item in items %}
          <option value="{{ item.id }}">{{ item.name }} ({{ item.sku }})</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <input type="number" name="quantity[]" class="form-control quantity" value="1" min="0.01" step="0.01" required>
      </td>
      <td>
        <input type="number" name="unit_cost[]" class="form-control unit-cost" value="0" min="0" step="0.01" required>
      </td>
      <td class="align-middle">
        $<span class="item-total">0.00</span>
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-danger remove-item">Remove</button>
      </td>
    `;
    
    container.appendChild(newRow);
    
    // Add event listeners to the new inputs
    const quantityInput = newRow.querySelector('.quantity');
    const unitCostInput = newRow.querySelector('.unit-cost');
    
    quantityInput.addEventListener('input', calculateTotals);
    unitCostInput.addEventListener('input', calculateTotals);
    
    // Add event listener to the new remove button
    newRow.querySelector('.remove-item').addEventListener('click', function() {
      this.closest('tr').remove();
      calculateTotals();
    });
    
    calculateTotals();
  });

  // Remove item functionality for initial row
  document.querySelectorAll('.remove-item').forEach(button => {
    button.addEventListener('click', function() {
      const row = this.closest('tr');
      if (document.querySelectorAll('#items-container tr').length > 1) {
        row.remove();
        calculateTotals();
      } else {
        alert('At least one item is required.');
      }
    });
  });

  // Calculate totals when quantity or unit cost changes
  document.querySelectorAll('input[name="quantity[]"], input[name="unit_cost[]"]').forEach(input => {
    input.addEventListener('input', calculateTotals);
  });

  function calculateTotals() {
    let subtotal = 0;
    
    document.querySelectorAll('#items-container tr').forEach(row => {
      const quantity = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
      const unitCost = parseFloat(row.querySelector('input[name="unit_cost[]"]').value) || 0;
      const itemTotal = quantity * unitCost;
      
      row.querySelector('.item-total').textContent = itemTotal.toFixed(2);
      subtotal += itemTotal;
    });
    
    const taxRate = 0; // Assuming 0% tax for now
    const tax = subtotal * taxRate;
    const total = subtotal + tax;
    
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('tax').textContent = tax.toFixed(2);
    document.getElementById('total').textContent = total.toFixed(2);
  }
});

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  const orderDateInput = document.querySelector('input[name="order_date"]');
  if (orderDateInput.value === '') {
    orderDateInput.value = today;
  }
});
</script>
{% endblock %}