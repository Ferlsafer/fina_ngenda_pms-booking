{% extends "hms/layout/base.html" %}
{% block title %}Purchase Orders{% endblock %}

{% block content %}
<div class="container-xl">
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">Purchase Orders</h2>
      </div>
      <div class="col-auto ms-auto">
        <a href="{{ url_for('hms.purchase_order_add') }}" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          New Purchase Order
        </a>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-3">
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <select class="form-select" name="status">
            <option value="">All Statuses</option>
            <option value="draft" {% if request.args.get('status') == 'draft' %}selected{% endif %}>Draft</option>
            <option value="ordered" {% if request.args.get('status') == 'ordered' %}selected{% endif %}>Ordered</option>
            <option value="received" {% if request.args.get('status') == 'received' %}selected{% endif %}>Received</option>
            <option value="cancelled" {% if request.args.get('status') == 'cancelled' %}selected{% endif %}>Cancelled</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="supplier">
            <option value="">All Suppliers</option>
            {% for supplier in suppliers %}
            <option value="{{ supplier.id }}" {% if request.args.get('supplier')|int == supplier.id %}selected{% endif %}>
              {{ supplier.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <rect x="4" y="5" width="16" height="16" rx="2" />
                <line x1="16" y1="3" x2="16" y2="7" />
                <line x1="8" y1="3" x2="8" y2="7" />
                <line x1="4" y1="11" x2="20" y2="11" />
                <line x1="11" y1="15" x2="12" y2="15" />
                <line x1="12" y1="15" x2="12" y2="18" />
              </svg>
            </span>
            <input type="date" class="form-control" name="from_date" value="{{ request.args.get('from_date', '') }}" placeholder="From date">
            <input type="date" class="form-control" name="to_date" value="{{ request.args.get('to_date', '') }}" placeholder="To date">
          </div>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Purchase Orders Table -->
  <div class="card">
    <div class="table-responsive">
      <table class="table table-vcenter card-table">
        <thead>
          <tr>
            <th>PO #</th>
            <th>Supplier</th>
            <th>Order Date</th>
            <th>Expected Date</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th class="w-1"></th>
          </tr>
        </thead>
        <tbody>
          {% for po in purchase_orders %}
          <tr>
            <td>
              <a href="#">PO-{{ po.po_number }}</a>
              <div class="text-muted small">
                {{ po.created_at.strftime('%b %d, %Y') }}
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="flex-fill">
                  <div class="font-weight-medium">{{ po.supplier.name }}</div>
                  <div class="text-muted small">{{ po.supplier.contact_person or 'No contact' }}</div>
                </div>
              </div>
            </td>
            <td>{{ po.order_date.strftime('%b %d, %Y') if po.order_date else 'Not set' }}</td>
            <td>{{ po.expected_date.strftime('%b %d, %Y') if po.expected_date else 'Not set' }}</td>
            <td class="text-muted">
              {{ po.items|length }} item{% if po.items|length != 1 %}s{% endif %}
            </td>
            <td class="text-nowrap">${{ "%.2f"|format(po.total_amount) }}</td>
            <td>
              {% if po.status == 'draft' %}
                <span class="badge bg-secondary">Draft</span>
              {% elif po.status == 'ordered' %}
                <span class="badge bg-primary">Ordered</span>
              {% elif po.status == 'received' %}
                <span class="badge bg-success">Received</span>
              {% elif po.status == 'cancelled' %}
                <span class="badge bg-danger">Cancelled</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group">
                <a href="#" class="btn btn-sm btn-outline-primary">View</a>
                <div class="dropdown">
                  <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" href="#">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-item-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                          <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
                          <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
                        </svg>
                        Edit
                      </a>
                    </li>
                    {% if po.status == 'draft' %}
                    <li>
                      <a class="dropdown-item" href="#" onclick="return confirm('Mark PO-{{ po.po_number }} as ordered?')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-item-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                          <path d="M5 12l5 5l10 -10" />
                        </svg>
                        Mark as Ordered
                      </a>
                    </li>
                    {% endif %}
                    {% if po.status == 'ordered' %}
                    <li>
                      <a class="dropdown-item" href="#">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-item-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                          <path d="M10 14l2 -2l8 8" />
                          <path d="M21 12a9 9 0 1 1 -18 0a9 9 0 0 1 18 0z" />
                        </svg>
                        Receive Items
                      </a>
                    </li>
                    {% endif %}
                    {% if po.status in ['draft', 'ordered'] %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <a class="dropdown-item text-danger" href="#" onclick="return confirm('Cancel PO-{{ po.po_number }}? This action cannot be undone.')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-item-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                          <line x1="18" y1="6" x2="6" y2="18" />
                          <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                        Cancel PO
                      </a>
                    </li>
                    {% endif %}
                  </ul>
                </div>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              No purchase orders found
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    {% if pagination and pagination.pages > 1 %}
    <div class="card-footer d-flex align-items-center">
      <p class="m-0 text-muted">
        Showing <span>{{ pagination.first }}</span> to <span>{{ pagination.last }}</span> of <span>{{ pagination.total }}</span> entries
      </p>
      <ul class="pagination m-0 ms-auto">
        {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('hms.inventory_purchase_orders') }}">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <polyline points="15 6 9 12 15 18" />
            </svg>
            prev
          </a>
        </li>
        {% endif %}
        
        {% for page in pagination.iter_pages() %}
          {% if page %}
            <li class="page-item {% if page == pagination.page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('hms.inventory_purchase_orders', page=page, **request.args) }}">{{ page }}</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">â€¦</span></li>
          {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('hms.inventory_purchase_orders') }}">
            next
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <polyline points="9 6 15 12 9 18" />
            </svg>
          </a>
        </li>
        {% endif %}
      </ul>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize any tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Handle date range picker if needed
  // You can add a date range picker library here if desired
});
</script>
{% endblock %}
