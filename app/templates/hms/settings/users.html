{% extends "hms/layout/base.html" %}
{% block title %}User Management - Hotel PMS{% endblock %}

{% block content %}
<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">User management</h2>
      <div class="text-muted mt-1">Users, roles, and account status</div>
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal" data-action="add">Add user</button>
    </div>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-vcenter card-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Last login</th>
          <th class="w-1">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in (users if users is defined else []) %}
        <tr>
          <td>
            <span class="avatar avatar-sm me-2" style="background-image: url(https://ui-avatars.com/api/?name={{ u.name|urlencode }}&background=random)"></span>
            {{ u.name }}
          </td>
          <td>{{ u.email }}</td>
          <td><span class="badge bg-secondary">{{ u.role_name or u.role or 'No Role' }}</span></td>
          <td>
            <span class="badge bg-{{ 'success' if u.active else 'danger' }}">{{ 'Active' if u.active else 'Inactive' }}</span>
          </td>
          <td>{{ u.last_login_at.strftime('%Y-%m-%d %H:%M') if u.last_login_at else 'â€”' }}</td>
          <td>
            <div class="btn-list-sm">
              <button type="button" class="btn btn-sm btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#userModal"
                onclick="editUser(this)"
                data-id="{{ u.id }}"
                data-name="{{ u.name }}"
                data-email="{{ u.email }}"
                data-role="{{ u.role_id or '' }}"
                data-active="{{ 'true' if u.active else 'false' }}">Edit</button>
              
              {% if u.email != current_user.email %}
              <!-- Set Password Button -->
              <button type="button" class="btn btn-sm btn-warning"
                data-bs-toggle="modal"
                data-bs-target="#setPasswordModal"
                onclick="setPasswordUser(this)"
                data-id="{{ u.id }}"
                data-name="{{ u.name }}"
                data-email="{{ u.email }}">Set Password</button>
              
              <!-- Reset Password (Generate Temporary) -->
              <form action="{{ url_for('hms.settings_users_reset_password', user_id=u.id) }}" method="POST" class="d-inline" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-outline-warning" onclick="return confirm('Reset password for {{ u.name }}? A temporary password will be generated and shown.')">Reset</button>
              </form>
              
              <!-- Delete User -->
              <form action="{{ url_for('hms.settings_users_delete', user_id=u.id) }}" method="POST" class="d-inline" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete user {{ u.name }}? This cannot be undone.')">Delete</button>
              </form>
              {% else %}
              <span class="text-muted small">You</span>
              {% endif %}
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-muted text-center py-4">No users found. Click "Add user" to create one.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal modal-blur fade" id="userModal" tabindex="-1" role="dialog" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="post" action="{{ url_for('hms.settings_users') }}" id="user-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="user_id" id="user-id" value="">
        <div class="modal-header">
          <h5 class="modal-title" id="user-modal-title">Add user</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label required">Name</label>
            <input type="text" name="name" class="form-control" id="user-name" required>
          </div>
          <div class="mb-3">
            <label class="form-label required">Email</label>
            <input type="email" name="email" class="form-control" id="user-email" required>
            <div class="form-hint d-none" id="email-hint">Leave password blank to keep current.</div>
          </div>
          <div class="mb-3" id="password-row">
            <label class="form-label">Password</label>
            <input type="password" name="password" class="form-control" id="user-password">
          </div>
          <div class="mb-3">
            <label class="form-label required">Role</label>
            <select name="role_id" class="form-select" id="user-role" required>
              <option value="">Select a role</option>
              {% for r in (roles if roles is defined else []) %}
              <option value="{{ r.id }}">{{ r.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-0">
            <label class="form-check form-switch">
              <input type="checkbox" name="active" class="form-check-input" id="user-active" value="1" checked>
              <span class="form-check-label">Account active</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="user-spinner" role="status"></span>
            Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Edit user function - reads data from button attributes
function editUser(btn) {
  var id = btn.getAttribute('data-id');
  var name = btn.getAttribute('data-name');
  var email = btn.getAttribute('data-email');
  var role = btn.getAttribute('data-role');
  var active = btn.getAttribute('data-active') === 'true';

  document.getElementById('user-modal-title').textContent = 'Edit user';
  document.getElementById('user-id').value = id;
  document.getElementById('user-name').value = name;
  document.getElementById('user-email').value = email;
  document.getElementById('user-password').value = '';
  document.getElementById('user-password').required = false;
  document.getElementById('password-row').classList.remove('d-none');
  document.getElementById('email-hint').classList.remove('d-none');

  if (role) {
    document.getElementById('user-role').value = role;
  }

  document.getElementById('user-active').checked = active;
}

// Set Password Modal
function setPasswordUser(btn) {
  var id = btn.getAttribute('data-id');
  var name = btn.getAttribute('data-name');
  var email = btn.getAttribute('data-email');
  
  document.getElementById('set-password-user-id').value = id;
  document.getElementById('set-password-user-name').textContent = name;
  document.getElementById('set-password-email').textContent = email;
  document.getElementById('set-password-input').value = '';
}

document.addEventListener('DOMContentLoaded', function() {
  // Add user button - clear form
  var addBtn = document.querySelector('[data-bs-target="#userModal"][data-action="add"]');
  if (addBtn) {
    addBtn.addEventListener('click', function() {
      document.getElementById('user-modal-title').textContent = 'Add user';
      document.getElementById('user-id').value = '';
      document.getElementById('user-name').value = '';
      document.getElementById('user-email').value = '';
      document.getElementById('user-password').value = '';
      document.getElementById('user-password').required = true;
      document.getElementById('password-row').classList.remove('d-none');
      document.getElementById('email-hint').classList.add('d-none');
      document.getElementById('user-active').checked = true;
      document.getElementById('user-role').value = '';
    });
  }

  // Show spinner on form submit
  var userForm = document.getElementById('user-form');
  if (userForm) {
    userForm.addEventListener('submit', function() {
      document.getElementById('user-spinner').classList.remove('d-none');
    });
  }
});
</script>

<!-- Set Password Modal -->
<div class="modal modal-blur fade" id="setPasswordModal" tabindex="-1" role="dialog" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="post" action="{{ url_for('hms.settings_users_set_password') }}" id="set-password-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="user_id" id="set-password-user-id" value="">
        <div class="modal-header">
          <h5 class="modal-title">Set Password for <span id="set-password-user-name"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">
            Set a new password for <strong id="set-password-email"></strong>
          </p>
          
          <div class="mb-3">
            <label class="form-label required">New Password</label>
            <input type="password" name="password" class="form-control" id="set-password-input" required minlength="8" placeholder="Enter new password">
            <small class="text-muted">Minimum 8 characters</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label required">Confirm Password</label>
            <input type="password" name="confirm_password" class="form-control" required minlength="8" placeholder="Confirm new password">
          </div>
          
          <div class="alert alert-info">
            <strong>Note:</strong> The user will need to log in with this new password. Consider sharing it securely.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Set Password</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
